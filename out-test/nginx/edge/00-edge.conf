# Generated by render script
# - SNI vhosts for WordPress + Zabbix

# Real IP behind Cloudflare (optional but recommended)
# The render script can optionally inject set_real_ip_from lines.
real_ip_header CF-Connecting-IP;
real_ip_recursive on;

log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                '$status $body_bytes_sent "$http_referer" '
                '"$http_user_agent" "$http_x_forwarded_for"';

access_log /var/log/nginx/access.log main;
error_log  /var/log/nginx/error.log warn;

# Common proxy headers
map $http_upgrade $connection_upgrade {
  default upgrade;
  '' close;
}

server {
  listen 443 ssl http2;
  server_name example.com *.example.com;

  ssl_certificate     /etc/letsencrypt/live/example.com/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;

  include /etc/nginx/snippets/ssl-params.conf;

  location / {
    proxy_pass http://wp-a-nginx:80;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
  }
}


server {
  listen 443 ssl http2;
  server_name example.me *.example.me;

  ssl_certificate     /etc/letsencrypt/live/example.me/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/example.me/privkey.pem;

  include /etc/nginx/snippets/ssl-params.conf;

  location / {
    proxy_pass http://wp-b-nginx:80;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
  }
}


server {
  listen 443 ssl http2;
  server_name zabbix.ops.example.net;

  ssl_certificate     /etc/letsencrypt/live/zabbix.ops.example.net/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/zabbix.ops.example.net/privkey.pem;

  include /etc/nginx/snippets/ssl-params.conf;

  location / {
    proxy_pass http://zbx-web:8080;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
  }
}

